import React, { useState, useEffect, useCallback, useRef } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow, TableCaption } from '@/components/ui/table';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter, DialogTrigger, DialogClose } from '@/components/ui/dialog';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { PlusCircle, Edit, Trash2, Search, FileUp, FileDown, User, Phone, KeyRound, Mail, Eye, EyeOff, Camera, UploadCloud, Wrench } from 'lucide-react';
import { useToast } from '@/components/ui/use-toast';
import { motion } from 'framer-motion';
import { supabase } from '@/lib/supabaseClient';

const TechniciensPage = () => {
  const { toast } = useToast();
  const [techniciens, setTechniciens] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [currentTechnicien, setCurrentTechnicien] = useState(null);
  const [formData, setFormData] = useState({
    matricule: '', nom: '', prenom: '', telephone: '', email: '', motDePasse: '', photo_url: null
  });
  const [showMotDePasse, setShowMotDePasse] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [photoFile, setPhotoFile] = useState(null);
  const [isTakingPhoto, setIsTakingPhoto] = useState(false);
  const videoRef = useRef(null);
  const canvasRef = useRef(null);

  const loadData = useCallback(async () => {
    setIsLoading(true);
    const { data: techniciensData, error: techniciensError } = await supabase.from('techniciens').select('*').order('nom', { ascending: true });
    if (techniciensError) {
      toast({ title: 'Erreur chargement techniciens', description: techniciensError.message, variant: 'destructive' });
    } else {
      setTechniciens(techniciensData || []);
    }
    setIsLoading(false);
  }, [toast]);

  useEffect(() => {
    loadData();
  }, [loadData]);
  
  useEffect(() => {
    let stream;
    if (isTakingPhoto && videoRef.current) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(s => {
          stream = s;
          videoRef.current.srcObject = stream;
        })
        .catch(err => {
          console.error("Error accessing camera: ", err);
          toast({ title: "Erreur Caméra", description: "Impossible d'accéder à la caméra.", variant: "destructive" });
          setIsTakingPhoto(false);
        });
    }
    return () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
    };
  }, [isTakingPhoto, toast]);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const resetFormData = useCallback(() => {
    setFormData({
      matricule: '', nom: '', prenom: '', telephone: '', email: '', motDePasse: '', photo_url: null
    });
    setShowMotDePasse(false);
    setPhotoFile(null);
    setIsTakingPhoto(false);
  }, []);

  const handlePhotoUpload = (event) => {
    const file = event.target.files[0];
    if (file) {
      setPhotoFile(file);
      const reader = new FileReader();
      reader.onloadend = () => {
        setFormData(prev => ({ ...prev, photo_url: reader.result })); 
      };
      reader.readAsDataURL(file);
    }
  };

  const capturePhoto = () => {
    if (videoRef.current && canvasRef.current) {
      const video = videoRef.current;
      const canvas = canvasRef.current;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const context = canvas.getContext('2d');
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/png');
      
      fetch(dataUrl)
        .then(res => res.blob())
        .then(blob => {
          const file = new File([blob], "capture.png", { type: "image/png" });
          setPhotoFile(file);
          setFormData(prev => ({ ...prev, photo_url: dataUrl }));
          setIsTakingPhoto(false); 
        });
    }
  };

  const uploadPhotoToSupabase = async (file, matricule) => {
    if (!file) return null;
    const fileName = `photos_techniciens/${matricule}_${Date.now()}.${file.name.split('.').pop()}`;
    const { data, error } = await supabase.storage
      .from('pmu-mali-storage')
      .upload(fileName, file, {
        cacheControl: '3600',
        upsert: true, 
      });

    if (error) {
      toast({ title: "Erreur d'upload photo", description: error.message, variant: "destructive" });
      return null;
    }
    
    const { data: publicUrlData } = supabase.storage.from('pmu-mali-storage').getPublicUrl(data.path);
    return publicUrlData.publicUrl;
  };

  const handleSubmit = async () => {
    if (!formData.matricule || !formData.nom || !formData.prenom || !formData.email || !formData.motDePasse) {
      toast({ title: 'Erreur', description: 'Veuillez remplir tous les champs obligatoires (Matricule, Nom, Prénom, Email et Mot de passe).', variant: 'destructive' });
      return;
    }

    // Validation email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(formData.email)) {
      toast({ title: 'Erreur', description: 'Veuillez saisir une adresse email valide.', variant: 'destructive' });
      return;
    }

    setIsLoading(true);
    let uploadedPhotoUrl = currentTechnicien?.photo_url || null;

    if (photoFile) {
        const newUrl = await uploadPhotoToSupabase(photoFile, formData.matricule);
        if (newUrl) {
            uploadedPhotoUrl = newUrl;
        } else {
            setIsLoading(false);
            return; 
        }
    } else if (!formData.photo_url && currentTechnicien && currentTechnicien.photo_url) {
      uploadedPhotoUrl = null;
    }

    const dataToSave = { ...formData, photo_url: uploadedPhotoUrl };
    delete dataToSave.id; 

    let error;
    if (currentTechnicien) {
      const { error: updateError } = await supabase.from('techniciens').update(dataToSave).eq('id', currentTechnicien.id);
      error = updateError;
    } else {
      const { error: insertError } = await supabase.from('techniciens').insert(dataToSave);
      error = insertError;
    }

    if (error) {
      toast({ title: 'Erreur d\'enregistrement', description: error.message, variant: 'destructive' });
    } else {
      toast({ title: 'Succès', description: `Technicien ${currentTechnicien ? 'modifié' : 'ajouté'} avec succès.`, className: "bg-green-500 text-white" });
      setIsDialogOpen(false);
      setCurrentTechnicien(null);
      resetFormData();
      loadData();
    }
    setIsLoading(false);
  };

  const openDialog = (technicien = null) => {
    setCurrentTechnicien(technicien);
    if (technicien) {
      setFormData({ 
        ...technicien,
        photo_url: technicien.photo_url || null
      });
    } else {
      resetFormData();
    }
    setPhotoFile(null);
    setIsTakingPhoto(false);
    setIsDialogOpen(true);
  };

  const handleDelete = async (id) => {
    setIsLoading(true);
    const technicienToDelete = techniciens.find(t => t.id === id);
    if (technicienToDelete && technicienToDelete.photo_url) {
        try {
            const filePath = new URL(technicienToDelete.photo_url).pathname.split('/pmu-mali-storage/').pop();
            if (filePath) {
                await supabase.storage.from('pmu-mali-storage').remove([filePath]);
            }
        } catch (e) {
            console.error("Error parsing or deleting photo from storage:", e);
        }
    }

    const { error } = await supabase.from('techniciens').delete().eq('id', id);
    if (error) {
      toast({ title: 'Erreur de suppression', description: error.message, variant: 'destructive' });
    } else {
      toast({ title: 'Succès', description: 'Technicien supprimé.', className: "bg-red-500 text-white" });
      loadData();
    }
    setIsLoading(false);
  };

  const filteredTechniciens = techniciens.filter(t => 
    Object.entries(t).some(([key, val]) => {
      if (key === 'motDePasse' || key === 'photo_url') return false; 
      return String(val).toLowerCase().includes(searchTerm.toLowerCase());
    })
  );
  
  const itemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: { opacity: 1, y: 0 },
  };

  const convertToCSV = (data) => {
    if (!data || data.length === 0) return '';
    const headers = ['matricule', 'nom', 'prenom', 'telephone', 'email', 'photo_url'].join(',');
    const rows = data.map(row => 
      [row.matricule, row.nom, row.prenom, row.telephone || '', row.email, row.photo_url || ''].map(value => `"${String(value).replace(/"/g, '""')}"`).join(',')
    );
    return `${headers}\n${rows.join('\n')}`;
  };

  const handleExport = () => {
    const csvData = convertToCSV(techniciens);
    if (!csvData) {
        toast({ title: "Exportation échouée", description: "Aucune donnée à exporter.", variant: "destructive" });
        return;
    }
    const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'pmu_techniciens.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    toast({ title: "Exportation réussie", description: "Les données des techniciens ont été exportées au format CSV.", className: "bg-green-500 text-white" });
  };

  const handleImport = async (event) => {
    const file = event.target.files[0];
    if (file) {
      setIsLoading(true);
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const text = e.target.result;
          const rows = text.split('\n').filter(row => row.trim() !== '');
          if (rows.length < 2) throw new Error("Fichier CSV vide ou en-têtes manquants.");
          
          const headers = rows[0].trim().split(',').map(h => h.replace(/^"|"$/g, '').trim());
          const requiredHeaders = ['matricule', 'nom', 'prenom', 'email', 'motDePasse'];
          if (!requiredHeaders.every(rh => headers.includes(rh))) {
            throw new Error(`En-têtes manquants. Requis: ${requiredHeaders.join(', ')}. Présents: ${headers.join(', ')}`);
          }

          const dataToUpsert = rows.slice(1).map(rowStr => {
            const values = rowStr.split(',').map(v => v.replace(/^"|"$/g, '').replace(/""/g, '"').trim());
            let obj = {};
            headers.forEach((header, index) => {
              obj[header] = values[index];
            });
            return {
              matricule: obj.matricule,
              nom: obj.nom,
              prenom: obj.prenom,
              telephone: obj.telephone || null,
              email: obj.email,
              motDePasse: obj.motDePasse,
              photo_url: obj.photo_url || null, 
            };
          }).filter(item => item.matricule && item.nom && item.prenom && item.email && item.motDePasse);

          if (dataToUpsert.length > 0) {
            const { error } = await supabase.from('techniciens').upsert(dataToUpsert, { onConflict: 'matricule' });
            if (error) throw error;
            toast({ title: "Importation réussie", description: `${dataToUpsert.length} techniciens importés/mis à jour.`, className: "bg-green-500 text-white" });
            loadData();
          } else {
            toast({ title: "Erreur d'importation", description: "Aucune donnée valide trouvée dans le fichier CSV ou format incorrect.", variant: "destructive" });
          }
        } catch (error) {
          toast({ title: "Erreur d'importation", description: `Impossible de lire le fichier CSV: ${error.message}`, variant: "destructive" });
        } finally {
          setIsLoading(false);
        }
      };
      reader.readAsText(file, 'UTF-8');
    }
    if (event.target) event.target.value = null;
  };

  return (
    <motion.div 
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ duration: 0.5 }}
      className="space-y-6"
    >
      <Card className="shadow-xl glassmorphism">
        <CardHeader>
          <div className="flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
              <CardTitle className="text-3xl font-bold text-primary">Gestion des Techniciens</CardTitle>
              <CardDescription>Gérez les informations des techniciens de maintenance.</CardDescription>
            </div>
            <Dialog open={isDialogOpen} onOpenChange={(isOpen) => { setIsDialogOpen(isOpen); if (!isOpen) resetFormData(); }}>
              <DialogTrigger asChild>
                <Button onClick={() => openDialog()} className="bg-gradient-to-r from-primary to-blue-600 hover:from-primary/90 hover:to-blue-600/90 text-white" disabled={isLoading}>
                  <PlusCircle className="mr-2 h-5 w-5" /> Ajouter un Technicien
                </Button>
              </DialogTrigger>
              <DialogContent className="sm:max-w-lg glassmorphism">
                <DialogHeader>
                  <DialogTitle className="text-2xl text-primary">{currentTechnicien ? 'Modifier' : 'Ajouter'} un Technicien</DialogTitle>
                </DialogHeader>
                <div className="grid gap-4 py-4 max-h-[70vh] overflow-y-auto p-1">
                  {[
                    { id: 'matricule', label: 'Matricule', icon: <User className="h-4 w-4" /> },
                    { id: 'nom', label: 'Nom', icon: <User className="h-4 w-4" /> },
                    { id: 'prenom', label: 'Prénom', icon: <User className="h-4 w-4" /> },
                    { id: 'telephone', label: 'Numéro de Téléphone', type: 'tel', icon: <Phone className="h-4 w-4" /> },
                    { id: 'email', label: 'Email', type: 'email', icon: <Mail className="h-4 w-4" /> },
                    { id: 'motDePasse', label: 'Mot de passe', type: showMotDePasse ? 'text' : 'password', icon: <KeyRound className="h-4 w-4" />, isPassword: true }
                  ].map(field => (
                    <div className="grid grid-cols-4 items-center gap-4" key={field.id}>
                      <Label htmlFor={field.id} className="text-right flex items-center justify-end">
                        {field.icon && React.cloneElement(field.icon, { className: 'mr-1' })}
                        {field.label}
                      </Label>
                      <div className="col-span-3 relative">
                        <Input id={field.id} name={field.id} type={field.type || 'text'} value={formData[field.id] || ''} onChange={handleInputChange} className="pr-10" disabled={isLoading} />
                        {field.isPassword && (
                           <Button
                            type="button"
                            variant="ghost"
                            size="icon"
                            className="absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7"
                            onClick={() => setShowMotDePasse(prev => !prev)}
                            disabled={isLoading}
                          >
                            {showMotDePasse ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                          </Button>
                        )}
                      </div>
                    </div>
                  ))}
                  
                  <div className="grid grid-cols-4 items-center gap-4">
                    <Label htmlFor="photo" className="text-right flex items-center justify-end"><Camera className="h-4 w-4 mr-1" />Photo</Label>
                    <div className="col-span-3 space-y-2">
                        {formData.photo_url && typeof formData.photo_url === 'string' && (
                            <div className="mt-2">
                                <img src={formData.photo_url} alt="Aperçu photo" className="h-24 w-24 object-cover rounded border" />
                                <Button variant="link" size="sm" onClick={() => setFormData(prev => ({...prev, photo_url: null}))} disabled={isLoading}>Supprimer photo</Button>
                            </div>
                        )}
                         {isTakingPhoto && (
                            <div className="mt-2">
                                <video ref={videoRef} autoPlay className="w-full rounded border"></video>
                                <canvas ref={canvasRef} className="hidden"></canvas>
                                <div className="flex gap-2 mt-2">
                                    <Button onClick={capturePhoto} type="button" disabled={isLoading}>Prendre la photo</Button>
                                    <Button variant="outline" onClick={() => setIsTakingPhoto(false)} type="button" disabled={isLoading}>Annuler</Button>
                                </div>
                            </div>
                        )}
                        {!isTakingPhoto && (
                            <div className="flex gap-2">
                                <Button type="button" variant="outline" onClick={() => setIsTakingPhoto(true)} className="flex items-center" disabled={isLoading}>
                                    <Camera className="mr-2 h-4 w-4" /> Prendre Photo
                                </Button>
                                <Button asChild variant="outline" className="flex items-center" disabled={isLoading}>
                                    <Label htmlFor="photo-upload" className="cursor-pointer m-0 p-2 h-full">
                                        <UploadCloud className="mr-2 h-4 w-4" /> Uploader
                                    </Label>
                                </Button>
                                <Input id="photo-upload" type="file" accept="image/*" onChange={handlePhotoUpload} className="hidden" disabled={isLoading}/>
                            </div>
                        )}
                    </div>
                  </div>
                </div>
                <DialogFooter>
                  <DialogClose asChild><Button variant="outline" type="button" onClick={resetFormData} disabled={isLoading}>Annuler</Button></DialogClose>
                  <Button onClick={handleSubmit} className="bg-primary hover:bg-primary/90" disabled={isLoading}>
                    {isLoading ? 'Enregistrement...' : (currentTechnicien ? 'Sauvegarder' : 'Ajouter')}
                  </Button>
                </DialogFooter>
              </DialogContent>
            </Dialog>
          </div>
          <div className="mt-6 flex flex-col md:flex-row gap-4">
            <div className="relative flex-grow">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground" />
              <Input 
                type="text" 
                placeholder="Rechercher (Nom, Prénom, Matricule, Email...)" 
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="pl-10 w-full"
                disabled={isLoading}
              />
            </div>
             <div className="flex gap-2">
              <Button variant="outline" asChild disabled={isLoading}>
                <Label htmlFor="import-techniciens" className="cursor-pointer flex items-center">
                  <FileUp className="mr-2 h-4 w-4" /> Importer (CSV)
                  <Input type="file" id="import-techniciens" accept=".csv" onChange={handleImport} className="hidden" />
                </Label>
              </Button>
              <Button variant="outline" onClick={handleExport} disabled={isLoading || techniciens.length === 0}><FileDown className="mr-2 h-4 w-4" /> Exporter (CSV)</Button>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          {isLoading && techniciens.length === 0 ? (
            <p className="text-center text-muted-foreground py-8">Chargement des techniciens...</p>
          ) : (
            <Table>
              <TableCaption>{filteredTechniciens.length === 0 ? "Aucun technicien trouvé." : `Liste de ${filteredTechniciens.length} technicien(s).`}</TableCaption>
              <TableHeader>
                <TableRow>
                  <TableHead>Photo</TableHead>
                  <TableHead>Matricule</TableHead>
                  <TableHead>Nom</TableHead>
                  <TableHead>Prénom</TableHead>
                  <TableHead>Téléphone</TableHead>
                  <TableHead>Email</TableHead>
                  <TableHead className="text-right">Actions</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {filteredTechniciens.map((technicien, index) => (
                  <motion.tr 
                    key={technicien.id}
                    variants={itemVariants}
                    initial="hidden"
                    animate="visible"
                    transition={{ delay: index * 0.05 }}
                  >
                    <TableCell>
                      {technicien.photo_url ? (
                        <img src={technicien.photo_url} alt={`${technicien.prenom} ${technicien.nom}`} className="w-10 h-10 rounded-full object-cover" />
                      ) : (
                        <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                          <Wrench className="h-6 w-6 text-gray-400" />
                        </div>
                      )}
                    </TableCell>
                    <TableCell>{technicien.matricule}</TableCell>
                    <TableCell>{technicien.nom}</TableCell>
                    <TableCell>{technicien.prenom}</TableCell>
                    <TableCell>{technicien.telephone || 'N/A'}</TableCell>
                    <TableCell>{technicien.email}</TableCell>
                    <TableCell className="text-right space-x-1">
                      <Button variant="ghost" size="icon" onClick={() => openDialog(technicien)} className="text-blue-500 hover:text-blue-700" disabled={isLoading}>
                        <Edit className="h-4 w-4" />
                      </Button>
                      <Dialog>
                          <DialogTrigger asChild>
                            <Button variant="ghost" size="icon" className="text-red-500 hover:text-red-700" disabled={isLoading}>
                              <Trash2 className="h-4 w-4" />
                            </Button>
                          </DialogTrigger>
                          <DialogContent className="sm:max-w-md">
                              <DialogHeader>
                                  <DialogTitle>Confirmer la suppression</DialogTitle>
                                  <DialogDescription>
                                      Êtes-vous sûr de vouloir supprimer le technicien {technicien.prenom} {technicien.nom} ? Cette action est irréversible.
                                  </DialogDescription>
                              </DialogHeader>
                              <DialogFooter>
                                  <DialogClose asChild><Button variant="outline" disabled={isLoading}>Annuler</Button></DialogClose>
                                  <Button variant="destructive" onClick={() => handleDelete(technicien.id)} disabled={isLoading}>
                                    {isLoading ? 'Suppression...' : 'Supprimer'}
                                  </Button>
                              </DialogFooter>
                          </DialogContent>
                      </Dialog>
                    </TableCell>
                  </motion.tr>
                ))}
              </TableBody>
            </Table>
          )}
        </CardContent>
      </Card>
    </motion.div>
  );
};

export default TechniciensPage; 